<!DOCTYPE html>

<html>
<head>
  <title>State.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="OSG.html">
                OSG.js
              </a>
            
              
              <a class="source" href="BlendColor.html">
                BlendColor.js
              </a>
            
              
              <a class="source" href="BlendFunc.html">
                BlendFunc.js
              </a>
            
              
              <a class="source" href="BoundingBox.html">
                BoundingBox.js
              </a>
            
              
              <a class="source" href="BoundingSphere.html">
                BoundingSphere.js
              </a>
            
              
              <a class="source" href="BufferArray.html">
                BufferArray.js
              </a>
            
              
              <a class="source" href="Camera.html">
                Camera.js
              </a>
            
              
              <a class="source" href="ComputeMatrixFromNodePath.html">
                ComputeMatrixFromNodePath.js
              </a>
            
              
              <a class="source" href="CullFace.html">
                CullFace.js
              </a>
            
              
              <a class="source" href="CullSettings.html">
                CullSettings.js
              </a>
            
              
              <a class="source" href="CullStack.html">
                CullStack.js
              </a>
            
              
              <a class="source" href="CullVisitor.html">
                CullVisitor.js
              </a>
            
              
              <a class="source" href="Depth.html">
                Depth.js
              </a>
            
              
              <a class="source" href="DrawArrayLengths.html">
                DrawArrayLengths.js
              </a>
            
              
              <a class="source" href="DrawArrays.html">
                DrawArrays.js
              </a>
            
              
              <a class="source" href="DrawElements.html">
                DrawElements.js
              </a>
            
              
              <a class="source" href="EllipsoidModel.html">
                EllipsoidModel.js
              </a>
            
              
              <a class="source" href="FrameBufferObject.html">
                FrameBufferObject.js
              </a>
            
              
              <a class="source" href="FrameStamp.html">
                FrameStamp.js
              </a>
            
              
              <a class="source" href="Geometry.html">
                Geometry.js
              </a>
            
              
              <a class="source" href="Image.html">
                Image.js
              </a>
            
              
              <a class="source" href="KdTree.html">
                KdTree.js
              </a>
            
              
              <a class="source" href="KdTreeBuilder.html">
                KdTreeBuilder.js
              </a>
            
              
              <a class="source" href="Light.html">
                Light.js
              </a>
            
              
              <a class="source" href="LightSource.html">
                LightSource.js
              </a>
            
              
              <a class="source" href="LineWidth.html">
                LineWidth.js
              </a>
            
              
              <a class="source" href="Lod.html">
                Lod.js
              </a>
            
              
              <a class="source" href="Map.html">
                Map.js
              </a>
            
              
              <a class="source" href="Material.html">
                Material.js
              </a>
            
              
              <a class="source" href="Math.html">
                Math.js
              </a>
            
              
              <a class="source" href="Matrix.html">
                Matrix.js
              </a>
            
              
              <a class="source" href="MatrixTransform.html">
                MatrixTransform.js
              </a>
            
              
              <a class="source" href="Node.html">
                Node.js
              </a>
            
              
              <a class="source" href="NodeVisitor.html">
                NodeVisitor.js
              </a>
            
              
              <a class="source" href="Notify.html">
                Notify.js
              </a>
            
              
              <a class="source" href="Object.html">
                Object.js
              </a>
            
              
              <a class="source" href="PagedLOD.html">
                PagedLOD.js
              </a>
            
              
              <a class="source" href="PrimitiveSet.html">
                PrimitiveSet.js
              </a>
            
              
              <a class="source" href="Program.html">
                Program.js
              </a>
            
              
              <a class="source" href="Projection.html">
                Projection.js
              </a>
            
              
              <a class="source" href="Quat.html">
                Quat.js
              </a>
            
              
              <a class="source" href="RenderBin.html">
                RenderBin.js
              </a>
            
              
              <a class="source" href="RenderStage.html">
                RenderStage.js
              </a>
            
              
              <a class="source" href="Shader.html">
                Shader.js
              </a>
            
              
              <a class="source" href="ShaderGenerator.html">
                ShaderGenerator.js
              </a>
            
              
              <a class="source" href="Shape.html">
                Shape.js
              </a>
            
              
              <a class="source" href="Stack.html">
                Stack.js
              </a>
            
              
              <a class="source" href="State.html">
                State.js
              </a>
            
              
              <a class="source" href="StateAttribute.html">
                StateAttribute.js
              </a>
            
              
              <a class="source" href="StateGraph.html">
                StateGraph.js
              </a>
            
              
              <a class="source" href="StateSet.html">
                StateSet.js
              </a>
            
              
              <a class="source" href="Texture.html">
                Texture.js
              </a>
            
              
              <a class="source" href="TextureCubeMap.html">
                TextureCubeMap.js
              </a>
            
              
              <a class="source" href="TextureManager.html">
                TextureManager.js
              </a>
            
              
              <a class="source" href="Transform.html">
                Transform.js
              </a>
            
              
              <a class="source" href="TransformEnums.html">
                TransformEnums.js
              </a>
            
              
              <a class="source" href="TriangleIndexFunctor.html">
                TriangleIndexFunctor.js
              </a>
            
              
              <a class="source" href="Uniform.html">
                Uniform.js
              </a>
            
              
              <a class="source" href="UpdateVisitor.html">
                UpdateVisitor.js
              </a>
            
              
              <a class="source" href="Utils.html">
                Utils.js
              </a>
            
              
              <a class="source" href="Vec2.html">
                Vec2.js
              </a>
            
              
              <a class="source" href="Vec3.html">
                Vec3.js
              </a>
            
              
              <a class="source" href="Vec4.html">
                Vec4.js
              </a>
            
              
              <a class="source" href="Viewport.html">
                Viewport.js
              </a>
            
              
              <a class="source" href="WebGLCaps.html">
                WebGLCaps.js
              </a>
            
              
              <a class="source" href="osg.html">
                osg.js
              </a>
            
              
              <a class="source" href="Animation.html">
                Animation.js
              </a>
            
              
              <a class="source" href="AnimationUpdateCallback.html">
                AnimationUpdateCallback.js
              </a>
            
              
              <a class="source" href="BasicAnimationManager.html">
                BasicAnimationManager.js
              </a>
            
              
              <a class="source" href="Channel.html">
                Channel.js
              </a>
            
              
              <a class="source" href="Easing.html">
                Easing.js
              </a>
            
              
              <a class="source" href="FloatLerpChannel.html">
                FloatLerpChannel.js
              </a>
            
              
              <a class="source" href="FloatTarget.html">
                FloatTarget.js
              </a>
            
              
              <a class="source" href="Interpolator.html">
                Interpolator.js
              </a>
            
              
              <a class="source" href="Keyframe.html">
                Keyframe.js
              </a>
            
              
              <a class="source" href="LinkVisitor.html">
                LinkVisitor.js
              </a>
            
              
              <a class="source" href="QuatLerpChannel.html">
                QuatLerpChannel.js
              </a>
            
              
              <a class="source" href="QuatSlerpChannel.html">
                QuatSlerpChannel.js
              </a>
            
              
              <a class="source" href="QuatTarget.html">
                QuatTarget.js
              </a>
            
              
              <a class="source" href="Sampler.html">
                Sampler.js
              </a>
            
              
              <a class="source" href="StackedQuaternion.html">
                StackedQuaternion.js
              </a>
            
              
              <a class="source" href="StackedRotateAxis.html">
                StackedRotateAxis.js
              </a>
            
              
              <a class="source" href="StackedTranslate.html">
                StackedTranslate.js
              </a>
            
              
              <a class="source" href="Target.html">
                Target.js
              </a>
            
              
              <a class="source" href="UpdateMatrixTransform.html">
                UpdateMatrixTransform.js
              </a>
            
              
              <a class="source" href="Vec3LerpChannel.html">
                Vec3LerpChannel.js
              </a>
            
              
              <a class="source" href="Vec3Target.html">
                Vec3Target.js
              </a>
            
              
              <a class="source" href="osgAnimation.html">
                osgAnimation.js
              </a>
            
              
              <a class="source" href="Input.html">
                Input.js
              </a>
            
              
              <a class="source" href="Options.html">
                Options.js
              </a>
            
              
              <a class="source" href="ReaderParser.html">
                ReaderParser.js
              </a>
            
              
              <a class="source" href="osgDB.html">
                osgDB.js
              </a>
            
              
              <a class="source" href="FirstPersonManipulator.html">
                FirstPersonManipulator.js
              </a>
            
              
              <a class="source" href="FirstPersonManipulatorMouseKeyboardController.html">
                FirstPersonManipulatorMouseKeyboardController.js
              </a>
            
              
              <a class="source" href="FirstPersonManipulatorOculusController.html">
                FirstPersonManipulatorOculusController.js
              </a>
            
              
              <a class="source" href="Manipulator.html">
                Manipulator.js
              </a>
            
              
              <a class="source" href="OrbitManipulator.html">
                OrbitManipulator.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorEnums.html">
                OrbitManipulatorEnums.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorGamePadController.html">
                OrbitManipulatorGamePadController.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorHammerController.html">
                OrbitManipulatorHammerController.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorLeapMotionController.html">
                OrbitManipulatorLeapMotionController.js
              </a>
            
              
              <a class="source" href="OrbitManipulatorMouseKeyboardController.html">
                OrbitManipulatorMouseKeyboardController.js
              </a>
            
              
              <a class="source" href="SwitchManipulator.html">
                SwitchManipulator.js
              </a>
            
              
              <a class="source" href="osgGA.html">
                osgGA.js
              </a>
            
              
              <a class="source" href="osgNameSpace.html">
                osgNameSpace.js
              </a>
            
              
              <a class="source" href="Composer.html">
                Composer.js
              </a>
            
              
              <a class="source" href="IntersectVisitor.html">
                IntersectVisitor.js
              </a>
            
              
              <a class="source" href="Oculus.html">
                Oculus.js
              </a>
            
              
              <a class="source" href="ParameterVisitor.html">
                ParameterVisitor.js
              </a>
            
              
              <a class="source" href="TriangleIntersect.html">
                TriangleIntersect.js
              </a>
            
              
              <a class="source" href="WebVR.html">
                WebVR.js
              </a>
            
              
              <a class="source" href="osgPool.html">
                osgPool.js
              </a>
            
              
              <a class="source" href="osgUtil.html">
                osgUtil.js
              </a>
            
              
              <a class="source" href="View.html">
                View.js
              </a>
            
              
              <a class="source" href="Viewer.html">
                Viewer.js
              </a>
            
              
              <a class="source" href="EventProxy.html">
                EventProxy.js
              </a>
            
              
              <a class="source" href="GamePad.html">
                GamePad.js
              </a>
            
              
              <a class="source" href="Hammer.html">
                Hammer.js
              </a>
            
              
              <a class="source" href="LeapMotion.html">
                LeapMotion.js
              </a>
            
              
              <a class="source" href="Oculus.html">
                Oculus.js
              </a>
            
              
              <a class="source" href="StandardMouseKeyboard.html">
                StandardMouseKeyboard.js
              </a>
            
              
              <a class="source" href="osgViewer.html">
                osgViewer.js
              </a>
            
              
              <a class="source" href="stats.html">
                stats.js
              </a>
            
              
              <a class="source" href="webgl-debug.html">
                webgl-debug.js
              </a>
            
              
              <a class="source" href="webgl-utils.html">
                webgl-utils.js
              </a>
            
              
              <a class="source" href="osg.html">
                osg.js
              </a>
            
              
              <a class="source" href="osgAnimation.html">
                osgAnimation.js
              </a>
            
              
              <a class="source" href="Hammer.html">
                Hammer.js
              </a>
            
              
              <a class="source" href="Leap.html">
                Leap.js
              </a>
            
              
              <a class="source" href="Q.html">
                Q.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>State.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>define( [
    <span class="hljs-string">'osg/StateAttribute'</span>,
    <span class="hljs-string">'osg/Stack'</span>,
    <span class="hljs-string">'osg/Uniform'</span>,
    <span class="hljs-string">'osg/Matrix'</span>,
    <span class="hljs-string">'osg/ShaderGenerator'</span>,
    <span class="hljs-string">'osg/Map'</span>
], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( StateAttribute, Stack, Uniform, Matrix, ShaderGenerator, Map )</span> {</span>

    <span class="hljs-keyword">var</span> State = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">this</span>._graphicContext = <span class="hljs-literal">undefined</span>;

        <span class="hljs-keyword">this</span>.currentVBO = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">this</span>.vertexAttribList = [];
        <span class="hljs-keyword">this</span>.programs = Stack.create();
        <span class="hljs-keyword">this</span>.stateSets = Stack.create();
        <span class="hljs-keyword">this</span>.uniforms = <span class="hljs-keyword">new</span> Map();

        <span class="hljs-keyword">this</span>.textureAttributeMapList = [];

        <span class="hljs-keyword">this</span>.attributeMap = <span class="hljs-keyword">new</span> Map();

        <span class="hljs-keyword">this</span>.shaderGenerator = <span class="hljs-keyword">new</span> ShaderGenerator();

        <span class="hljs-keyword">this</span>.modelViewMatrix = Uniform.createMatrix4( Matrix.create(), <span class="hljs-string">'ModelViewMatrix'</span> );
        <span class="hljs-keyword">this</span>.projectionMatrix = Uniform.createMatrix4( Matrix.create(), <span class="hljs-string">'ProjectionMatrix'</span> );
        <span class="hljs-keyword">this</span>.normalMatrix = Uniform.createMatrix4( Matrix.create(), <span class="hljs-string">'NormalMatrix'</span> );</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>track uniform for color array enabled</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Stoped HERE color array does not work
check point cloud example</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> arrayColorEnable = Stack.create();
        arrayColorEnable.globalDefault = Uniform.createFloat1( <span class="hljs-number">0.0</span>, <span class="hljs-string">'ArrayColorEnabled'</span> );

        <span class="hljs-keyword">this</span>.uniforms.setMap( {
            ArrayColorEnabled: arrayColorEnable
        } );


        <span class="hljs-keyword">this</span>.vertexAttribMap = {};
        <span class="hljs-keyword">this</span>.vertexAttribMap._disable = [];
        <span class="hljs-keyword">this</span>.vertexAttribMap._keys = [];
    };

    State.prototype = {

        setGraphicContext: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( graphicContext )</span> {</span>
            <span class="hljs-keyword">this</span>._graphicContext = graphicContext;
        },
        getGraphicContext: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._graphicContext;
        },

        pushStateSet: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( stateset )</span> {</span>
            <span class="hljs-keyword">this</span>.stateSets.push( stateset );

            <span class="hljs-keyword">if</span> ( stateset.attributeMap ) {
                <span class="hljs-keyword">this</span>.pushAttributeMap( <span class="hljs-keyword">this</span>.attributeMap, stateset.attributeMap );
            }
            <span class="hljs-keyword">if</span> ( stateset.textureAttributeMapList ) {
                <span class="hljs-keyword">var</span> list = stateset.textureAttributeMapList;
                <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> textureUnit = <span class="hljs-number">0</span>, l = list.length; textureUnit &lt; l; textureUnit++ ) {
                    <span class="hljs-keyword">if</span> ( list[ textureUnit ] === <span class="hljs-literal">undefined</span> ) {
                        <span class="hljs-keyword">continue</span>;
                    }
                    <span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">this</span>.textureAttributeMapList[ textureUnit ] ) {
                        <span class="hljs-keyword">this</span>.textureAttributeMapList[ textureUnit ] = <span class="hljs-keyword">new</span> Map();
                    }
                    <span class="hljs-keyword">this</span>.pushAttributeMap( <span class="hljs-keyword">this</span>.textureAttributeMapList[ textureUnit ], list[ textureUnit ] );
                }
            }

            <span class="hljs-keyword">if</span> ( stateset.uniforms ) {
                <span class="hljs-keyword">this</span>.pushUniformsList( <span class="hljs-keyword">this</span>.uniforms, stateset.uniforms );
            }
        },

        applyStateSet: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( stateset )</span> {</span>
            <span class="hljs-keyword">this</span>.pushStateSet( stateset );
            <span class="hljs-keyword">this</span>.apply();
            <span class="hljs-keyword">this</span>.popStateSet();
        },

        popAllStateSets: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">while</span> ( <span class="hljs-keyword">this</span>.stateSets.length ) {
                <span class="hljs-keyword">this</span>.popStateSet();
            }
        },
        popStateSet: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> stateset = <span class="hljs-keyword">this</span>.stateSets.pop();
            <span class="hljs-keyword">if</span> ( stateset.program ) {
                <span class="hljs-keyword">this</span>.programs.pop();
            }
            <span class="hljs-keyword">if</span> ( stateset.attributeMap ) {
                <span class="hljs-keyword">this</span>.popAttributeMap( <span class="hljs-keyword">this</span>.attributeMap, stateset.attributeMap );
            }
            <span class="hljs-keyword">if</span> ( stateset.textureAttributeMapList ) {
                <span class="hljs-keyword">var</span> list = stateset.textureAttributeMapList;
                <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> textureUnit = <span class="hljs-number">0</span>, l = list.length; textureUnit &lt; l; textureUnit++ ) {
                    <span class="hljs-keyword">if</span> ( list[ textureUnit ] === <span class="hljs-literal">undefined</span> ) {
                        <span class="hljs-keyword">continue</span>;
                    }
                    <span class="hljs-keyword">this</span>.popAttributeMap( <span class="hljs-keyword">this</span>.textureAttributeMapList[ textureUnit ], list[ textureUnit ] );
                }
            }

            <span class="hljs-keyword">if</span> ( stateset.uniforms ) {
                <span class="hljs-keyword">this</span>.popUniformsList( <span class="hljs-keyword">this</span>.uniforms, stateset.uniforms );
            }
        },

        haveAppliedAttribute: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( attribute )</span> {</span>
            <span class="hljs-keyword">var</span> key = attribute.getTypeMember();
            <span class="hljs-keyword">var</span> attributeStack = <span class="hljs-keyword">this</span>.attributeMap[ key ];
            attributeStack.lastApplied = attribute;
            attributeStack.asChanged = <span class="hljs-literal">true</span>;
        },

        applyAttribute: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( attribute )</span> {</span>
            <span class="hljs-keyword">var</span> key = attribute.getTypeMember();

            <span class="hljs-keyword">var</span> attributeMap = <span class="hljs-keyword">this</span>.attributeMap;
            <span class="hljs-keyword">var</span> attributeStack = attributeMap[ key ];

            <span class="hljs-keyword">if</span> ( attributeStack === <span class="hljs-literal">undefined</span> ) {
                attributeStack = Stack.create();
                attributeMap[ key ] = attributeStack;
                attributeMap[ key ].globalDefault = attribute.cloneType();
                <span class="hljs-keyword">this</span>.attributeMap.dirty();
            }

            <span class="hljs-keyword">if</span> ( attributeStack.lastApplied !== attribute ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <pre><code>   <span class="hljs-keyword">if</span> (attributeStack.lastApplied !== attribute || attribute.isDirty()) {
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> ( attribute.apply ) {
                    attribute.apply( <span class="hljs-keyword">this</span> );
                }
                attributeStack.lastApplied = attribute;
                attributeStack.asChanged = <span class="hljs-literal">true</span>;
            }
        },
        applyTextureAttribute: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( unit, attribute )</span> {</span>
            <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>.getGraphicContext();
            gl.activeTexture( gl.TEXTURE0 + unit );
            <span class="hljs-keyword">var</span> key = attribute.getTypeMember();

            <span class="hljs-keyword">if</span> ( !<span class="hljs-keyword">this</span>.textureAttributeMapList[ unit ] ) {
                <span class="hljs-keyword">this</span>.textureAttributeMapList[ unit ] = <span class="hljs-keyword">new</span> Map();
            }

            <span class="hljs-keyword">var</span> textureUnitAttributeMap = <span class="hljs-keyword">this</span>.textureAttributeMapList[ unit ];
            <span class="hljs-keyword">var</span> attributeStack = textureUnitAttributeMap[ key ];

            <span class="hljs-keyword">if</span> ( attributeStack === <span class="hljs-literal">undefined</span> ) {

                attributeStack = Stack.create();
                textureUnitAttributeMap[ key ] = attributeStack;
                textureUnitAttributeMap.dirty();
                attributeStack.globalDefault = attribute.cloneType();

            }

            <span class="hljs-keyword">if</span> ( attributeStack.lastApplied !== attribute ) {

                <span class="hljs-keyword">if</span> ( attribute.apply ) {
                    attribute.apply( <span class="hljs-keyword">this</span> );
                }
                attributeStack.lastApplied = attribute;
                attributeStack.asChanged = <span class="hljs-literal">true</span>;
            }
        },

        getLastProgramApplied: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.programs.lastApplied;
        },

        pushGeneratedProgram: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> program;
            <span class="hljs-keyword">var</span> attributeMap = <span class="hljs-keyword">this</span>.attributeMap;

            <span class="hljs-keyword">if</span> ( attributeMap.Program !== <span class="hljs-literal">undefined</span> &amp;&amp; attributeMap.Program.length !== <span class="hljs-number">0</span> ) {
                program = attributeMap.Program.back().object;
                <span class="hljs-keyword">var</span> value = attributeMap.Program.back().value;
                <span class="hljs-keyword">if</span> ( program !== <span class="hljs-literal">undefined</span> &amp;&amp; value !== StateAttribute.OFF ) {
                    <span class="hljs-keyword">this</span>.programs.push( <span class="hljs-keyword">this</span>.getObjectPair( program, value ) );
                    <span class="hljs-keyword">return</span> program;
                }
            }

            <span class="hljs-keyword">var</span> attributes = {
                <span class="hljs-string">'textureAttributeMapList'</span>: <span class="hljs-keyword">this</span>.textureAttributeMapList,
                <span class="hljs-string">'attributeMap'</span>: <span class="hljs-keyword">this</span>.attributeMap
            };

            <span class="hljs-keyword">var</span> generator = <span class="hljs-keyword">this</span>.stateSets.back().getShaderGenerator();
            <span class="hljs-keyword">if</span> ( generator === <span class="hljs-literal">undefined</span> ) {
                generator = <span class="hljs-keyword">this</span>.shaderGenerator;
            }
            program = generator.getOrCreateProgram( attributes );
            <span class="hljs-keyword">this</span>.programs.push( <span class="hljs-keyword">this</span>.getObjectPair( program, StateAttribute.ON ) );
            <span class="hljs-keyword">return</span> program;
        },

        popGeneratedProgram: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.programs.pop();
        },

        applyWithoutProgram: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.applyAttributeMap( <span class="hljs-keyword">this</span>.attributeMap );
            <span class="hljs-keyword">this</span>.applyTextureAttributeMapList( <span class="hljs-keyword">this</span>.textureAttributeMapList );
        },

        computeForeignUniforms: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( programUniformMap, activeUniformMap )</span> {</span>
            <span class="hljs-keyword">var</span> uniformMapKeys = programUniformMap.getKeys();
            <span class="hljs-keyword">var</span> uniformMap = programUniformMap;

            <span class="hljs-keyword">var</span> foreignUniforms = [];
            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = uniformMapKeys.length; i &lt; l; i++ ) {
                <span class="hljs-keyword">var</span> name = uniformMapKeys[ i ];
                <span class="hljs-keyword">var</span> location = uniformMap[ name ];
                <span class="hljs-keyword">if</span> ( location !== <span class="hljs-literal">undefined</span> &amp;&amp; activeUniformMap[ name ] === <span class="hljs-literal">undefined</span> ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>filter ‘standard’ uniform matrix that will be applied for all shader</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> ( name !== <span class="hljs-keyword">this</span>.modelViewMatrix.name &amp;&amp;
                         name !== <span class="hljs-keyword">this</span>.projectionMatrix.name &amp;&amp;
                         name !== <span class="hljs-keyword">this</span>.normalMatrix.name &amp;&amp;
                         name !== <span class="hljs-string">'ArrayColorEnabled'</span> ) {
                             foreignUniforms.push( name );
                         }
                }
            }
            <span class="hljs-keyword">return</span> foreignUniforms;
        },

        removeUniformsNotRequiredByProgram: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( activeUniformMap, programUniformMap )</span> {</span>

            <span class="hljs-keyword">var</span> activeUniformMapKeys = activeUniformMap.getKeys();

            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = activeUniformMapKeys.length; i &lt; l; i++ ) {
                <span class="hljs-keyword">var</span> name = activeUniformMapKeys[ i ];
                <span class="hljs-keyword">var</span> location = programUniformMap[ name ];
                <span class="hljs-keyword">if</span> ( location === <span class="hljs-literal">undefined</span> || location === <span class="hljs-literal">null</span> ) {
                    <span class="hljs-keyword">delete</span> activeUniformMap[ name ];
                    activeUniformMap.dirty();
                }
            }
        },



        cacheUniformsForGeneratedProgram: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( program )</span> {</span>

            <span class="hljs-keyword">var</span> foreignUniforms = <span class="hljs-keyword">this</span>.computeForeignUniforms( program.uniformsCache, program.activeUniforms );
            program.foreignUniforms = foreignUniforms;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>remove uniforms listed by attributes (getActiveUniforms) but not required by the program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.removeUniformsNotRequiredByProgram( program.activeUniforms, program.uniformsCache );

        },

        applyGeneratedProgram: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( program )</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>note that about TextureAttribute that need uniform on unit we would need to improve
the current uniformList …</p>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>when we apply the shader for the first time, we want to compute the active uniforms for this shader and the list of uniforms not extracted from attributes called foreignUniforms</p>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>typically the following code will be executed once on the first execution of generated program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
            <span class="hljs-keyword">var</span> foreignUniformKeys = program.foreignUniforms;
            <span class="hljs-keyword">if</span> ( !foreignUniformKeys ) {
                <span class="hljs-keyword">this</span>.cacheUniformsForGeneratedProgram( program );
                foreignUniformKeys = program.foreignUniforms;
            }


            <span class="hljs-keyword">var</span> programUniformMap = program.uniformsCache;
            <span class="hljs-keyword">var</span> activeUniformMap = program.activeUniforms;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>apply active uniforms
caching uniforms from attribtues make it impossible to overwrite uniform with a custom uniform instance not used in the attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> i,l, name, location;
            <span class="hljs-keyword">var</span> activeUniformKeys = activeUniformMap.getKeys();

            <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>, l = activeUniformKeys.length; i &lt; l; i++ ) {

                name = activeUniformKeys[ i ];
                location = programUniformMap[ name ];
                activeUniformMap[ name ].apply( <span class="hljs-keyword">this</span>._graphicContext, location );

            }

            <span class="hljs-keyword">var</span> uniformMapStack = <span class="hljs-keyword">this</span>.uniforms;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>apply now foreign uniforms, it’s uniforms needed by the program but not contains in attributes used to generate this program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>, l = foreignUniformKeys.length; i &lt; l; i++ ) {

                name = foreignUniformKeys[ i ];
                <span class="hljs-keyword">var</span> uniformStack = uniformMapStack[ name ];
                location = programUniformMap[ name ];
                <span class="hljs-keyword">var</span> uniform;

                <span class="hljs-keyword">if</span> ( uniformStack !== <span class="hljs-literal">undefined</span> ) {

                    <span class="hljs-keyword">if</span> ( uniformStack.length === <span class="hljs-number">0</span> ) {
                        uniform = uniformStack.globalDefault;
                    } <span class="hljs-keyword">else</span> {
                        uniform = uniformStack.back().object;
                    }

                    uniform.apply( <span class="hljs-keyword">this</span>._graphicContext, location );
                }

            }
        },

        apply: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">this</span>.applyAttributeMap( <span class="hljs-keyword">this</span>.attributeMap );
            <span class="hljs-keyword">this</span>.applyTextureAttributeMapList( <span class="hljs-keyword">this</span>.textureAttributeMapList );

            <span class="hljs-keyword">this</span>.pushGeneratedProgram();
            <span class="hljs-keyword">var</span> program = <span class="hljs-keyword">this</span>.programs.back().object;
            <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>.programs.lastApplied !== program ) {
                program.apply( <span class="hljs-keyword">this</span> );
                <span class="hljs-keyword">this</span>.programs.lastApplied = program;
            }

            <span class="hljs-keyword">if</span> ( program.generated === <span class="hljs-literal">true</span> ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>will cache uniform and apply them with the program</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                <span class="hljs-keyword">this</span>.applyGeneratedProgram( program );

            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>custom program so we will iterate on uniform from the program and apply them
but in order to be able to use Attribute in the state graph we will check if
our program want them. It must be defined by the user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">this</span>.applyCustomProgram( program );

            }
        },



        getActiveUniformsFromProgramAttributes: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( program, activeUniformsList )</span> {</span>

            <span class="hljs-keyword">var</span> attributeMapStack = <span class="hljs-keyword">this</span>.attributeMap;

            <span class="hljs-keyword">var</span> attributeKeys = program.trackAttributes.attributeKeys;

            <span class="hljs-keyword">if</span> ( attributeKeys.length &gt; <span class="hljs-number">0</span> ) {

                <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = attributeKeys.length; i &lt; l; i++ ) {

                    <span class="hljs-keyword">var</span> key = attributeKeys[ i ];
                    <span class="hljs-keyword">var</span> attributeStack = attributeMapStack[ key ];
                    <span class="hljs-keyword">if</span> ( attributeStack === <span class="hljs-literal">undefined</span> ) {
                        <span class="hljs-keyword">continue</span>;
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>we just need the uniform list and not the attribute itself</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> attribute = attributeStack.globalDefault;
                    <span class="hljs-keyword">if</span> ( attribute.getOrCreateUniforms === <span class="hljs-literal">undefined</span> ) {
                        <span class="hljs-keyword">continue</span>;
                    }

                    <span class="hljs-keyword">var</span> uniformMap = attribute.getOrCreateUniforms();
                    <span class="hljs-keyword">var</span> uniformKeys = uniformMap.getKeys();

                    <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> a = <span class="hljs-number">0</span>, b = uniformKeys.length; a &lt; b; a++ ) {
                        activeUniformsList.push( uniformMap[ uniformKeys[ a ] ] );
                    }
                }

            }
        },

        getActiveUniformsFromProgramTextureAttributes: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( program, activeUniformsList )</span> {</span>

            <span class="hljs-keyword">var</span> textureAttributeKeysList = program.trackAttributes.textureAttributeKeys;
            <span class="hljs-keyword">if</span> ( textureAttributeKeysList === <span class="hljs-literal">undefined</span> ) <span class="hljs-keyword">return</span>;

            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> unit = <span class="hljs-number">0</span>, nbUnit = textureAttributeKeysList.length; unit &lt; nbUnit; unit++ ) {

                <span class="hljs-keyword">var</span> textureAttributeKeys = textureAttributeKeysList[ unit ];
                <span class="hljs-keyword">if</span> ( textureAttributeKeys === <span class="hljs-literal">undefined</span> ) <span class="hljs-keyword">continue</span>;

                <span class="hljs-keyword">var</span> unitTextureAttributeList = <span class="hljs-keyword">this</span>.textureAttributeMapList[ unit ];
                <span class="hljs-keyword">if</span> ( unitTextureAttributeList === <span class="hljs-literal">undefined</span> ) <span class="hljs-keyword">continue</span>;

                <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = textureAttributeKeys.length; i &lt; l; i++ ) {
                    <span class="hljs-keyword">var</span> key = textureAttributeKeys[ i ];

                    <span class="hljs-keyword">var</span> attributeStack = unitTextureAttributeList[ key ];
                    <span class="hljs-keyword">if</span> ( attributeStack === <span class="hljs-literal">undefined</span> ) {
                        <span class="hljs-keyword">continue</span>;
                    }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>we just need the uniform list and not the attribute itself</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> attribute = attributeStack.globalDefault;
                    <span class="hljs-keyword">if</span> ( attribute.getOrCreateUniforms === <span class="hljs-literal">undefined</span> ) {
                        <span class="hljs-keyword">continue</span>;
                    }
                    <span class="hljs-keyword">var</span> uniformMap = attribute.getOrCreateUniforms();
                    <span class="hljs-keyword">var</span> uniformMapKeys = uniformMap.getKeys();

                    <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> a = <span class="hljs-number">0</span>, b = uniformMapKeys.length; a &lt; b; a++ ) {
                        activeUniformsList.push( uniformMap[ uniformMapKeys[ a ] ] );
                    }
                }
            }
        },

        cacheUniformsForCustomProgram: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( program, activeUniformsList )</span> {</span>

            <span class="hljs-keyword">this</span>.getActiveUniformsFromProgramAttributes( program, activeUniformsList );

            <span class="hljs-keyword">this</span>.getActiveUniformsFromProgramTextureAttributes( program, activeUniformsList );

            <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>._graphicContext;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>now we have a list on uniforms we want to track but we will filter them to use only what is needed by our program
not that if you create a uniforms whith the same name of a tracked attribute, and it will override it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> uniformsFinal = <span class="hljs-keyword">new</span> Map();

            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = activeUniformsList.length; i &lt; l; i++ ) {
                <span class="hljs-keyword">var</span> u = activeUniformsList[ i ];
                <span class="hljs-keyword">var</span> loc = gl.getUniformLocation( program.program, u.name );
                <span class="hljs-keyword">if</span> ( loc !== <span class="hljs-literal">undefined</span> &amp;&amp; loc !== <span class="hljs-literal">null</span> ) {
                    uniformsFinal[ u.name ] = u;
                }
            }
            uniformsFinal.dirty();
            program.trackUniforms = uniformsFinal;

        },

        applyCustomProgram: (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>

            <span class="hljs-keyword">var</span> activeUniformsList = [];

            <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( program )</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>custom program so we will iterate on uniform from the program and apply them
but in order to be able to use Attribute in the state graph we will check if
our program want them. It must be defined by the user</p>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>first time we see attributes key, so we will keep a list of uniforms from attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                activeUniformsList.length = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>fill the program with cached active uniforms map from attributes and texture attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> ( program.trackAttributes !== <span class="hljs-literal">undefined</span> &amp;&amp; program.trackUniforms === <span class="hljs-literal">undefined</span> ) {
                    <span class="hljs-keyword">this</span>.cacheUniformsForCustomProgram( program, activeUniformsList );
                }

                <span class="hljs-keyword">var</span> programUniformMap = program.uniformsCache;
                <span class="hljs-keyword">var</span> programUniformKeys = programUniformMap.getKeys();
                <span class="hljs-keyword">var</span> uniformMapStackContent = <span class="hljs-keyword">this</span>.uniforms;

                <span class="hljs-keyword">var</span> programTrackUniformMap;
                <span class="hljs-keyword">if</span> ( program.trackUniforms )
                    programTrackUniformMap = program.trackUniforms;

                <span class="hljs-keyword">var</span> uniform;
                <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = programUniformKeys.length; i &lt; l; i++ ) {
                    <span class="hljs-keyword">var</span> uniformKey = programUniformKeys[ i ];
                    <span class="hljs-keyword">var</span> location = programUniformMap[ uniformKey ];
                    <span class="hljs-keyword">var</span> uniformStack = uniformMapStackContent[ uniformKey ];

                    <span class="hljs-keyword">if</span> ( uniformStack === <span class="hljs-literal">undefined</span> ) {

                        <span class="hljs-keyword">if</span> ( programTrackUniformMap !== <span class="hljs-literal">undefined</span> ) {
                            uniform = programTrackUniformMap[ uniformKey ];
                            <span class="hljs-keyword">if</span> ( uniform !== <span class="hljs-literal">undefined</span> ) {
                                uniform.apply( <span class="hljs-keyword">this</span>._graphicContext, location );
                            }
                        }

                    } <span class="hljs-keyword">else</span> {

                        <span class="hljs-keyword">if</span> ( uniformStack.length === <span class="hljs-number">0</span> ) {
                            uniform = uniformStack.globalDefault;
                        } <span class="hljs-keyword">else</span> {
                            uniform = uniformStack.back().object;
                        }
                        uniform.apply( <span class="hljs-keyword">this</span>._graphicContext, location );

                    }
                }
            };
        })(),

        applyAttributeMap: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( attributeMap )</span> {</span>
            <span class="hljs-keyword">var</span> attributeStack;

            <span class="hljs-keyword">var</span> attributeMapKeys = attributeMap.getKeys();

            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = attributeMapKeys.length; i &lt; l; i++ ) {
                <span class="hljs-keyword">var</span> key = attributeMapKeys[ i ];

                attributeStack = attributeMap[ key ];
                <span class="hljs-keyword">if</span> ( attributeStack === <span class="hljs-literal">undefined</span> ) {
                    <span class="hljs-keyword">continue</span>;
                }
                <span class="hljs-keyword">var</span> attribute;
                <span class="hljs-keyword">if</span> ( attributeStack.length === <span class="hljs-number">0</span> ) {
                    attribute = attributeStack.globalDefault;
                } <span class="hljs-keyword">else</span> {
                    attribute = attributeStack.back().object;
                }

                <span class="hljs-keyword">if</span> ( attributeStack.asChanged ) {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <pre><code>       <span class="hljs-keyword">if</span> (attributeStack.lastApplied !== attribute || attribute.isDirty()) {
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> ( attributeStack.lastApplied !== attribute ) {
                        <span class="hljs-keyword">if</span> ( attribute.apply ) {
                            attribute.apply( <span class="hljs-keyword">this</span> );
                        }
                        attributeStack.lastApplied = attribute;
                    }
                    attributeStack.asChanged = <span class="hljs-literal">false</span>;
                }
            }
        },

        getObjectPair: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( uniform, value )</span> {</span>
            <span class="hljs-keyword">return</span> {
                object: uniform,
                value: value
            };
        },

        pushUniformsList: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( uniformMap, stateSetUniformMap )</span> {</span>
            <span class="hljs-comment">/*jshint bitwise: false */</span>
            <span class="hljs-keyword">var</span> name;
            <span class="hljs-keyword">var</span> uniform;

            <span class="hljs-keyword">var</span> stateSetUniformMapKeys = stateSetUniformMap.getKeys();

            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = stateSetUniformMapKeys.length; i &lt; l; i++ ) {
                <span class="hljs-keyword">var</span> key = stateSetUniformMapKeys[ i ];
                <span class="hljs-keyword">var</span> uniformPair = stateSetUniformMap[ key ];
                uniform = uniformPair.getUniform();
                name = uniform.name;
                <span class="hljs-keyword">if</span> ( uniformMap[ name ] === <span class="hljs-literal">undefined</span> ) {
                    uniformMap[ name ] = Stack.create();
                    uniformMap[ name ].globalDefault = uniform;
                    uniformMap.dirty();
                }
                <span class="hljs-keyword">var</span> value = uniformPair.getValue();
                <span class="hljs-keyword">var</span> stack = uniformMap[ name ];
                <span class="hljs-keyword">if</span> ( stack.length === <span class="hljs-number">0</span> ) {
                    stack.push( <span class="hljs-keyword">this</span>.getObjectPair( uniform, value ) );
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( ( stack[ stack.length - <span class="hljs-number">1</span> ].value &amp; StateAttribute.OVERRIDE ) &amp;&amp; !( value &amp; StateAttribute.PROTECTED ) ) {
                    stack.push( stack[ stack.length - <span class="hljs-number">1</span> ] );
                } <span class="hljs-keyword">else</span> {
                    stack.push( <span class="hljs-keyword">this</span>.getObjectPair( uniform, value ) );
                }
            }
            <span class="hljs-comment">/*jshint bitwise: true */</span>
        },

        popUniformsList: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( uniformMap, stateSetUniformMap )</span> {</span>

            <span class="hljs-keyword">var</span> stateSetUniformMapKeys = stateSetUniformMap.getKeys();

            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = stateSetUniformMapKeys.length; i &lt; l; i++ ) {
                <span class="hljs-keyword">var</span> key = stateSetUniformMapKeys[ i ];
                uniformMap[ key ].pop();
            }
        },

        applyTextureAttributeMapList: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( textureAttributesMapList )</span> {</span>
            <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>._graphicContext;
            <span class="hljs-keyword">var</span> textureAttributeMap;

            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> textureUnit = <span class="hljs-number">0</span>, l = textureAttributesMapList.length; textureUnit &lt; l; textureUnit++ ) {
                textureAttributeMap = textureAttributesMapList[ textureUnit ];
                <span class="hljs-keyword">if</span> ( textureAttributeMap === <span class="hljs-literal">undefined</span> ) {
                    <span class="hljs-keyword">continue</span>;
                }


                <span class="hljs-keyword">var</span> textureAttributeMapKeys = textureAttributeMap.getKeys();

                <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, lt = textureAttributeMapKeys.length; i &lt; lt; i++ ) {
                    <span class="hljs-keyword">var</span> key = textureAttributeMapKeys[ i ];

                    <span class="hljs-keyword">var</span> attributeStack = textureAttributeMap[ key ];
                    <span class="hljs-keyword">if</span> ( attributeStack === <span class="hljs-literal">undefined</span> ) {
                        <span class="hljs-keyword">continue</span>;
                    }

                    <span class="hljs-keyword">var</span> attribute;
                    <span class="hljs-keyword">if</span> ( attributeStack.length === <span class="hljs-number">0</span> ) {
                        attribute = attributeStack.globalDefault;
                    } <span class="hljs-keyword">else</span> {
                        attribute = attributeStack.back().object;
                    }
                    <span class="hljs-keyword">if</span> ( attributeStack.asChanged ) {

                        gl.activeTexture( gl.TEXTURE0 + textureUnit );
                        attribute.apply( <span class="hljs-keyword">this</span>, textureUnit );
                        attributeStack.lastApplied = attribute;
                        attributeStack.asChanged = <span class="hljs-literal">false</span>;

                    }
                }
            }
        },
        setGlobalDefaultValue: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( attribute )</span> {</span>

            <span class="hljs-keyword">var</span> key = attribute.getTypeMember();
            <span class="hljs-keyword">var</span> attributeMap = <span class="hljs-keyword">this</span>.attributeMap;

            <span class="hljs-keyword">if</span> ( attributeMap[ key ] ) {
                attributeMap[ key ].globalDefault = attribute;

            } <span class="hljs-keyword">else</span> {
                attributeMap[ key ] = Stack.create();
                attributeMap[ key ].globalDefault = attribute;

                <span class="hljs-keyword">this</span>.attributeMap.dirty();
            }
        },

        pushAttributeMap: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( attributeMap, stateSetAttributeMap )</span> {</span>
            <span class="hljs-comment">/*jshint bitwise: false */</span>
            <span class="hljs-keyword">var</span> attributeStack;
            <span class="hljs-keyword">var</span> stateSetAttributeMapKeys = stateSetAttributeMap.getKeys();

            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = stateSetAttributeMapKeys.length; i &lt; l; i++ ) {

                <span class="hljs-keyword">var</span> type = stateSetAttributeMapKeys[ i ];
                <span class="hljs-keyword">var</span> attributePair = stateSetAttributeMap[ type ];
                <span class="hljs-keyword">var</span> attribute = attributePair.getAttribute();

                <span class="hljs-keyword">if</span> ( attributeMap[ type ] === <span class="hljs-literal">undefined</span> ) {
                    attributeMap[ type ] = Stack.create();
                    attributeMap[ type ].globalDefault = attribute.cloneType();

                    attributeMap.dirty();
                }

                <span class="hljs-keyword">var</span> value = attributePair.getValue();

                attributeStack = attributeMap[ type ];
                <span class="hljs-keyword">if</span> ( attributeStack.length === <span class="hljs-number">0</span> ) {
                    attributeStack.push( <span class="hljs-keyword">this</span>.getObjectPair( attribute, value ) );
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( ( attributeStack[ attributeStack.length - <span class="hljs-number">1</span> ].value &amp; StateAttribute.OVERRIDE ) &amp;&amp; !( value &amp; StateAttribute.PROTECTED ) ) {
                    attributeStack.push( attributeStack[ attributeStack.length - <span class="hljs-number">1</span> ] );
                } <span class="hljs-keyword">else</span> {
                    attributeStack.push( <span class="hljs-keyword">this</span>.getObjectPair( attribute, value ) );
                }

                attributeStack.asChanged = <span class="hljs-literal">true</span>;
            }
            <span class="hljs-comment">/*jshint bitwise: true */</span>
        },

        popAttributeMap: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( attributeMap, stateSetAttributeMap )</span> {</span>

            <span class="hljs-keyword">var</span> attributeStack;
            <span class="hljs-keyword">var</span> stateSetAttributeMapKeys = stateSetAttributeMap.getKeys();

            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = stateSetAttributeMapKeys.length; i &lt; l; i++ ) {

                <span class="hljs-keyword">var</span> type = stateSetAttributeMapKeys[ i ];
                attributeStack = attributeMap[ type ];
                attributeStack.pop();
                attributeStack.asChanged = <span class="hljs-literal">true</span>;

            }
        },

        setIndexArray: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( array )</span> {</span>
            <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>._graphicContext;
            <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>.currentIndexVBO !== array ) {
                array.bind( gl );
                <span class="hljs-keyword">this</span>.currentIndexVBO = array;
            }
            <span class="hljs-keyword">if</span> ( array.isDirty() ) {
                array.compile( gl );
            }
        },

        lazyDisablingOfVertexAttributes: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> keys = <span class="hljs-keyword">this</span>.vertexAttribMap._keys;
            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = keys.length; i &lt; l; i++ ) {
                <span class="hljs-keyword">var</span> attr = keys[ i ];
                <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>.vertexAttribMap[ attr ] ) {
                    <span class="hljs-keyword">this</span>.vertexAttribMap._disable[ attr ] = <span class="hljs-literal">true</span>;
                }
            }
        },

        applyDisablingOfVertexAttributes: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
            <span class="hljs-keyword">var</span> keys = <span class="hljs-keyword">this</span>.vertexAttribMap._keys;
            <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = keys.length; i &lt; l; i++ ) {
                <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>.vertexAttribMap._disable[ keys[ i ] ] === <span class="hljs-literal">true</span> ) {
                    <span class="hljs-keyword">var</span> attr = keys[ i ];
                    <span class="hljs-keyword">this</span>._graphicContext.disableVertexAttribArray( attr );
                    <span class="hljs-keyword">this</span>.vertexAttribMap._disable[ attr ] = <span class="hljs-literal">false</span>;
                    <span class="hljs-keyword">this</span>.vertexAttribMap[ attr ] = <span class="hljs-literal">false</span>;
                }
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>it takes 4.26% of global cpu
there would be a way to cache it and track state if the program has not changed …</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> program = <span class="hljs-keyword">this</span>.programs.lastApplied;

            <span class="hljs-keyword">if</span> ( program !== <span class="hljs-literal">undefined</span> ) {
                <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>.getGraphicContext();
                <span class="hljs-keyword">var</span> color  = program.attributesCache.Color;
                <span class="hljs-keyword">var</span> updateColorUniform = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">var</span> hasColorAttrib = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">if</span> ( color !== <span class="hljs-literal">undefined</span> ) {
                    hasColorAttrib = <span class="hljs-keyword">this</span>.vertexAttribMap[ color ];
                }

                <span class="hljs-keyword">var</span> uniform = <span class="hljs-keyword">this</span>.uniforms.ArrayColorEnabled.globalDefault;
                <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">this</span>.previousHasColorAttrib !== hasColorAttrib ) {
                    updateColorUniform = <span class="hljs-literal">true</span>;
                }

                <span class="hljs-keyword">this</span>.previousHasColorAttrib = hasColorAttrib;

                <span class="hljs-keyword">if</span> ( updateColorUniform ) {
                    <span class="hljs-keyword">if</span> ( hasColorAttrib ) {
                        uniform.get()[ <span class="hljs-number">0</span> ] = <span class="hljs-number">1.0</span>;
                    } <span class="hljs-keyword">else</span> {
                        uniform.get()[ <span class="hljs-number">0</span> ] = <span class="hljs-number">0.0</span>;
                    }
                    uniform.dirty();
                }

                uniform.apply( gl, program.uniformsCache.ArrayColorEnabled );
            }
        },
        setVertexAttribArray: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( attrib, array, normalize )</span> {</span>
            <span class="hljs-keyword">var</span> vertexAttribMap = <span class="hljs-keyword">this</span>.vertexAttribMap;
            vertexAttribMap._disable[ attrib ] = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">var</span> gl = <span class="hljs-keyword">this</span>._graphicContext;
            <span class="hljs-keyword">var</span> binded = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">if</span> ( array.isDirty() ) {
                array.bind( gl );
                array.compile( gl );
                binded = <span class="hljs-literal">true</span>;
            }

            <span class="hljs-keyword">if</span> ( vertexAttribMap[ attrib ] !== array ) {

                <span class="hljs-keyword">if</span> ( !binded ) {
                    array.bind( gl );
                }

                <span class="hljs-keyword">if</span> ( !vertexAttribMap[ attrib ] ) {
                    gl.enableVertexAttribArray( attrib );

                    <span class="hljs-keyword">if</span> ( vertexAttribMap[ attrib ] === <span class="hljs-literal">undefined</span> ) {
                        vertexAttribMap._keys.push( attrib );
                    }
                }

                vertexAttribMap[ attrib ] = array;
                gl.vertexAttribPointer( attrib, array._itemSize, gl.FLOAT, normalize, <span class="hljs-number">0</span>, <span class="hljs-number">0</span> );
            }
        }

    };

    <span class="hljs-keyword">return</span> State;
} );</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
